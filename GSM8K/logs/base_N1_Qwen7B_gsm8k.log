Using device: cuda
正在加载语言模型...
Loading checkpoint shards:   0%|                                                                                                                                                                                                    | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|███████████████████████████████████████████████                                                                                                                                             | 1/4 [00:01<00:03,  1.15s/it]Loading checkpoint shards:  50%|██████████████████████████████████████████████████████████████████████████████████████████████                                                                                              | 2/4 [00:02<00:02,  1.17s/it]Loading checkpoint shards:  75%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                               | 3/4 [00:03<00:01,  1.26s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:05<00:00,  1.35s/it]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:05<00:00,  1.30s/it]
语言模型加载完成!
正在加载数据集...
数据集加载完成，共5个样本
开始执行基于整个回答置信度的评估...
Processing: 0it [00:00, ?it/s]Processing: 0it [00:11, ?it/s, accuracy=1.0000]Processing: 1it [00:11, 11.53s/it, accuracy=1.0000]Processing: 2it [00:23, 11.99s/it, accuracy=1.0000]Processing: 3it [00:43, 15.67s/it, accuracy=1.0000]Processing: 3it [00:45, 15.05s/it, accuracy=1.0000]

--- 样本 1 调试信息 ---
问题: Janet’s ducks lay 16 eggs per day. She eats three for breakfast every morning and bakes muffins for her friends every day with four. She sells the remainder at the farmers' market daily for $2 per fresh duck egg. How much in dollars does she make every day at the farmers' market?
真实答案: 18
模型答案(提取): 18
清理后文本(保存的 answer): To determine how much Janet makes every day at the farmers' market, we need to follow these steps: 1. **Calculate the total number of eggs Janet collects each day:** Janet's ducks lay 16 eggs per day. 2. **Determine the number of eggs Janet eats each day:** Janet eats 3 eggs for breakfast every morning. 3. **Determine the number of eggs Janet uses each day for baking muffins:** Janet bakes muffins for her friends every day with 4 eggs. 4. **Calculate the total number of eggs Janet uses each day:** \[ \text{Total eggs used each day} = \text{Eggs eaten} + \text{Eggs used for baking} = 3 + 4 = 7 \] 5. **Calculate the number of eggs Janet has left each day:** \[ \text{Eggs left each day} = \text{Total eggs collected} - \text{Total eggs used} = 16 - 7 = 9 \] 6. **Determine the amount Janet sells each fresh duck egg:** Janet sells each fresh duck egg for $2. 7. **Calculate the total amount Janet makes each day at the farmers' market:** \[ \text{Total amount made each day} = \text{Eggs left each day} \times \text{Price per egg} = 9 \times 2 = 18 \] Therefore, the final numeric answer is \(\boxed{18}\).
最高置信度: 19.2569
是否正确: True
--- 结束调试信息 ---

Error generating candidates for sample 1: CUDA out of memory. Tried to allocate 42.00 MiB. GPU 0 has a total capacity of 31.47 GiB of which 37.31 MiB is free. Including non-PyTorch memory, this process has 15.24 GiB memory in use. Process 156414 has 16.18 GiB memory in use. Of the allocated memory 14.85 GiB is allocated by PyTorch, and 96.17 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
Error generating candidates for sample 2: CUDA out of memory. Tried to allocate 48.00 MiB. GPU 0 has a total capacity of 31.47 GiB of which 45.31 MiB is free. Including non-PyTorch memory, this process has 15.22 GiB memory in use. Process 156414 has 16.20 GiB memory in use. Of the allocated memory 14.86 GiB is allocated by PyTorch, and 65.44 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
Traceback (most recent call last):
  File "/root/autodl-tmp/Multi-step-Test-time-Training/GSM8K/base.py", line 107, in <module>
    main()
  File "/root/autodl-tmp/Multi-step-Test-time-Training/GSM8K/base.py", line 87, in main
    Response_Certainty_Selection(
  File "/root/autodl-tmp/Multi-step-Test-time-Training/GSM8K/methods/response_certainty.py", line 142, in Response_Certainty_Selection
    candidates = generate_with_transformers(
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/autodl-tmp/Multi-step-Test-time-Training/GSM8K/utils/common.py", line 156, in generate_with_transformers
    outputs = model.generate(input_ids, **generate_kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/utils/_contextlib.py", line 116, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/generation/utils.py", line 2629, in generate
    result = self._sample(
             ^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/generation/utils.py", line 3613, in _sample
    outputs = model_forward(**model_inputs, return_dict=True)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/utils/generic.py", line 959, in wrapper
    output = func(self, *args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/models/qwen2/modeling_qwen2.py", line 450, in forward
    outputs: BaseModelOutputWithPast = self.model(
                                       ^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/utils/generic.py", line 1083, in wrapper
    outputs = func(self, *args, **kwargs)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/models/qwen2/modeling_qwen2.py", line 379, in forward
    hidden_states = decoder_layer(
                    ^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/modeling_layers.py", line 94, in __call__
    return super().__call__(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/models/qwen2/modeling_qwen2.py", line 231, in forward
    hidden_states, _ = self.self_attn(
                       ^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1751, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/torch/nn/modules/module.py", line 1762, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/models/qwen2/modeling_qwen2.py", line 161, in forward
    key_states, value_states = past_key_value.update(key_states, value_states, self.layer_idx, cache_kwargs)
                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/cache_utils.py", line 992, in _wrapped_update
    key_tensors, value_tensors = fn(self, key_states, value_states, layer_idx, cache_kwargs)
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/cache_utils.py", line 1201, in update
    return self.layers[layer_idx].update(key_states, value_states, cache_kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/root/miniconda3/lib/python3.12/site-packages/transformers/cache_utils.py", line 103, in update
    self.values = torch.cat([self.values, value_states], dim=-2)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt
Using device: cuda
正在加载语言模型...
Loading checkpoint shards:   0%|                                                                                                                                                                                                    | 0/4 [00:00<?, ?it/s]Loading checkpoint shards:  25%|███████████████████████████████████████████████                                                                                                                                             | 1/4 [00:00<00:01,  1.99it/s]Loading checkpoint shards:  50%|██████████████████████████████████████████████████████████████████████████████████████████████                                                                                              | 2/4 [00:00<00:00,  2.06it/s]Loading checkpoint shards:  75%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████                                               | 3/4 [00:01<00:00,  2.57it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:01<00:00,  3.07it/s]Loading checkpoint shards: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:01<00:00,  2.70it/s]
语言模型加载完成!
正在加载数据集...
数据集加载完成，共2个样本
开始执行基于整个回答置信度的评估...
Processing: 0it [00:00, ?it/s]Processing: 0it [00:07, ?it/s, accuracy=1.0000]Processing: 1it [00:07,  7.13s/it, accuracy=1.0000]Processing: 1it [00:11,  7.13s/it, accuracy=1.0000]Processing: 2it [00:11,  5.49s/it, accuracy=1.0000]Processing: 2it [00:11,  5.73s/it, accuracy=1.0000]

--- 样本 1 调试信息 ---
问题: Janet’s ducks lay 16 eggs per day. She eats three for breakfast every morning and bakes muffins for her friends every day with four. She sells the remainder at the farmers' market daily for $2 per fresh duck egg. How much in dollars does she make every day at the farmers' market?
真实答案: 18
模型答案(提取): 18
清理后文本(保存的 answer): To determine how much Janet makes every day at the farmers' market, we need to follow these steps: 1. Calculate the total number of eggs Janet collects each day. 2. Determine how many eggs Janet consumes daily (eats for breakfast and uses for baking). 3. Calculate the number of eggs remaining after consumption. 4. Multiply the number of remaining eggs by the price per egg to find out how much she makes each day. Let's go through each step in detail: 1. Janet’s ducks lay 16 eggs per day. 2. Janet eats 3 eggs for breakfast every morning and bakes 4 eggs for her friends every day. So, the total number of eggs she consumes daily is: \[ 3 + 4 = 7 \text{ eggs} \] 3. The number of eggs remaining after consumption is: \[ 16 - 7 = 9 \text{ eggs} \] 4. Janet sells the remaining eggs at the farmers' market for $2 per egg. Therefore, the amount she makes each day is: \[ 9 \times 2 = 18 \text{ dollars} \] So, the final answer is: \[ \boxed{18} \]
最高置信度: 20.9442
是否正确: True
--- 结束调试信息 ---


--- 样本 2 调试信息 ---
问题: A robe takes 2 bolts of blue fiber and half that much white fiber.  How many bolts in total does it take?
真实答案: 3
模型答案(提取): 3
清理后文本(保存的 answer): To determine the total number of bolts of fiber needed for the robe, we need to follow these steps: 1. Identify the amount of blue fiber required. According to the problem, the robe takes 2 bolts of blue fiber. 2. Determine the amount of white fiber required. The problem states that the robe takes half as much white fiber as blue fiber. Therefore, the amount of white fiber is: \[ \frac{2}{2} = 1 \text{ bolt} \] 3. Calculate the total amount of fiber by adding the bolts of blue fiber and the bolts of white fiber: \[ 2 + 1 = 3 \text{ bolts} \] Thus, the total number of bolts of fiber needed is \(\boxed{3}\).
最高置信度: 21.4777
是否正确: True
--- 结束调试信息 ---

########################################################################################
Accuracy of Model@1: 1.0000.
Total samples: 2, Correct: 2
Elapsed time: 11.47 secs.
########################################################################################
Results saved to ./TTT_data/Self_Certainty_Trajectorylevel_best_of_1_Qwen7B_GSM8K.json
########################################################################################
实验配置参数:
########################################################################################
                   method ===> response-certainty
    n_repetitive_sampling ===> 1
              temperature ===> 0.7
                    top_p ===> 1.0
               model_path ===> Qwen/Qwen2.5-Math-7B-Instruct
             save_to_json ===> True
        dataset_repo_name ===> openai/gsm8k
               max_tokens ===> 512
              subset_size ===> 2
########################################################################################
