# CoT-Analyze-Toolkit: æ¨ç†èƒ½åŠ›è¯„ä¼°ä¸æ•°æ®ç­›é€‰å·¥å…·ç®±

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªç”¨äºè¯„ä¼°å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ€ç»´é“¾ï¼ˆChain-of-Thought, CoTï¼‰æ¨ç†èƒ½åŠ›çš„ç»¼åˆå·¥å…·åŒ…ã€‚é¡¹ç›®æ ¸å¿ƒå…³æ³¨ç‚¹åœ¨äº**è‡ªæ´½æ€§ï¼ˆSelf-Consistency, SCï¼‰**ã€**ä¸ç¡®å®šæ€§é‡åŒ–ï¼ˆç†µ/ç¡®ä¿¡åº¦ï¼‰ä»¥åŠé¢å‘å¼ºåŒ–å­¦ä¹ ï¼ˆRLï¼‰æˆ–å¾®è°ƒçš„é«˜è´¨é‡æ•°æ®ç­›é€‰**ã€‚

ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

1.  **é«˜æ•ˆç”Ÿæˆ**ï¼šåˆ©ç”¨ `vLLM` å¿«é€Ÿå¯¹æ•°å­¦é—®é¢˜è¿›è¡Œå¤šè·¯é‡‡æ ·ã€‚
2.  **æŒ‡æ ‡è®¡ç®—**ï¼šè®¡ç®—ç»†ç²’åº¦çš„ Token çº§å’Œ Step çº§æŒ‡æ ‡ï¼ˆå¦‚ LogProbã€Entropyã€Perplexityï¼‰ã€‚
3.  **ç­–ç•¥åˆ†æ**ï¼šè¯„ä¼°ä¸åŒé€‰è§£ç­–ç•¥ï¼ˆå¦‚åŸºäºç†µçš„ç¨³å®šæ€§ç­›é€‰ï¼‰ç›¸æ¯”ä¼ ç»ŸæŠ•ç¥¨æ³•çš„æ•ˆæœã€‚
4.  **éš¾åº¦åˆ†çº§**ï¼šåŸºäºä¸€è‡´æ€§åˆ†æ•°å°†æ•°æ®åˆ’åˆ†ä¸ºâ€œç®€å•/ä¸­ç­‰/å›°éš¾â€æ¡¶ï¼Œç”¨äºè¯¾ç¨‹å­¦ä¹ æˆ– RL è®­ç»ƒã€‚

## ğŸ“‹ ç›®å½•

  - [ç¯å¢ƒè¦æ±‚](https://www.google.com/search?q=%23%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82)
  - [æµç¨‹æ¦‚è§ˆ](https://www.google.com/search?q=%23%E6%B5%81%E7%A8%8B%E6%A6%82%E8%A7%88)
  - [ä½¿ç”¨æŒ‡å—](https://www.google.com/search?q=%23%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97)
      - [1. æ•°æ®ç”Ÿæˆ (Self-Consistency)](https://www.google.com/search?q=%231-%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90-self-consistency)
      - [2. ç»†ç²’åº¦æŒ‡æ ‡è®¡ç®—](https://www.google.com/search?q=%232-%E7%BB%86%E7%B2%92%E5%BA%A6%E6%8C%87%E6%A0%87%E8%AE%A1%E7%AE%97)
      - [3. åŸºç¡€è¯„ä¼°ä¸éš¾é¢˜æŒ–æ˜](https://www.google.com/search?q=%233-%E5%9F%BA%E7%A1%80%E8%AF%84%E4%BC%B0%E4%B8%8E%E9%9A%BE%E9%A2%98%E6%8C%96%E6%8E%98)
      - [4. é«˜çº§ç­–ç•¥åˆ†æ](https://www.google.com/search?q=%234-%E9%AB%98%E7%BA%A7%E7%AD%96%E7%95%A5%E5%88%86%E6%9E%90)
      - [5. æ•°æ®åˆ†çº§ç­›é€‰](https://www.google.com/search?q=%235-%E6%95%B0%E6%8D%AE%E5%88%86%E7%BA%A7%E7%AD%9B%E9%80%89)
  - [æ ¸å¿ƒæŒ‡æ ‡è¯´æ˜](https://www.google.com/search?q=%23%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87%E8%AF%B4%E6%98%8E)

## ğŸ›  ç¯å¢ƒè¦æ±‚

è¯·ç¡®ä¿å®‰è£…ä»¥ä¸‹æ ¸å¿ƒä¾èµ–åº“ï¼š

```bash
pip install torch transformers vllm numpy datasets tqdm
```

## ğŸš€ æµç¨‹æ¦‚è§ˆ

æ•´ä¸ª Pipeline åŒ…å«ä»¥ä¸‹å‡ ä¸ªç‹¬ç«‹ä¸”é€’è¿›çš„æ¨¡å—ï¼š

1.  **`self-consistency.py`**: ä½¿ç”¨ `vLLM` å¯¹æ¯ä¸ªé—®é¢˜ç”Ÿæˆ $N$ æ¡æ¨ç†è·¯å¾„ï¼Œå¹¶è®¡ç®— Majority Voteï¼ˆæŠ•ç¥¨ï¼‰ç»“æœã€‚
2.  **`evaluate.py`**: é‡æ–°è¿‡ä¸€éæ¨¡å‹ï¼ˆåŸºäº Transformersï¼‰ï¼Œè·å–å®Œæ•´çš„ Logitsï¼Œè®¡ç®—**ç†µï¼ˆEntropyï¼‰**ã€\*\*ç¡®ä¿¡åº¦ï¼ˆCertaintyï¼‰**ä»¥åŠ**æ­¥éª¤çº§ï¼ˆStep-wiseï¼‰\*\*æŒ‡æ ‡ã€‚
3.  **`analyze_data_insights.py`**: æ¨¡æ‹Ÿå¹¶è¯„æµ‹é«˜çº§é€‰è§£ç­–ç•¥ï¼ˆä¾‹å¦‚ï¼šåŠ æƒ Z-Scoreã€æ··åˆç¨³å®šæ€§ç­–ç•¥ï¼‰ï¼ŒéªŒè¯æ˜¯å¦èƒ½è¶…è¶Šä¼ ç»Ÿçš„ SC æŠ•ç¥¨ã€‚
4.  **`evaluate-sc.py`**: è½»é‡çº§åˆ†æå·¥å…·ï¼Œç”¨äºç»Ÿè®¡å‡†ç¡®ç‡å¹¶æŒ–æ˜â€œä½ç½®ä¿¡åº¦â€çš„å›°éš¾æ ·æœ¬ã€‚
5.  **`filter_difficulty.py`**: å°†ç”Ÿæˆçš„æ¨ç†è·¯å¾„æŒ‰ç…§éš¾åº¦è¿›è¡Œæ¸…æ´—å’Œåˆ†æ¡¶ï¼Œå¯¼å‡ºä¸º RL è®­ç»ƒæ•°æ®ã€‚

-----

## ğŸ’» ä½¿ç”¨æŒ‡å—

### 1\. æ•°æ®ç”Ÿæˆ (Self-Consistency)

ä½¿ç”¨ **vLLM** è¿›è¡Œé«˜ååé‡ç”Ÿæˆã€‚æ”¯æŒå¦‚ `HuggingFaceH4/MATH-500` ç­‰æ ‡å‡†æ•°æ®é›†ã€‚

```bash
python self-consistency.py \
    --model_path Qwen/Qwen2.5-Math-1.5B \
    --dataset_name HuggingFaceH4/MATH-500 \
    --output_file data/math500_candidates.jsonl \
    --num_return_sequences 4 \
    --temperature 0.5
```

  * **è¾“å‡º**: åŒ…å« $N$ æ¡å€™é€‰å›å¤å’ŒåŸºç¡€è‡ªæ´½æ€§åˆ†æ•°çš„ JSONL æ–‡ä»¶ã€‚

### 2\. ç»†ç²’åº¦æŒ‡æ ‡è®¡ç®—

è®¡ç®— Token çº§å’Œæ­¥éª¤çº§çš„ä¸ç¡®å®šæ€§æŒ‡æ ‡ã€‚
*æ³¨æ„ï¼šæ­¤è„šæœ¬éœ€è¦è·å–å®Œæ•´ Logitsï¼Œæ˜¾å­˜å ç”¨è¾ƒé«˜ï¼Œå»ºè®®æ ¹æ®æ˜¾å­˜è°ƒæ•´ batch\_sizeã€‚*

```bash
python evaluate.py \
    --model_path Qwen/Qwen2.5-Math-1.5B \
    --input_file data/math500_candidates.jsonl \
    --output_file data/math500_detailed.jsonl \
    --batch_size 4
```

  * **æ ¸å¿ƒå­—æ®µ**: `avg_entropy` (å¹³å‡ç†µ), `avg_certainty` (ç¡®ä¿¡åº¦), `perplexity` (å›°æƒ‘åº¦), ä»¥åŠç»“æ„åŒ–çš„ `steps` åˆ†æã€‚
  * 
### 3\. é«˜çº§ç­–ç•¥åˆ†æ

åˆ†æåŸºäºç†µï¼ˆEntropyï¼‰çš„é€‰è§£ç­–ç•¥æ˜¯å¦ä¼˜äºä¼ ç»Ÿçš„æŠ•ç¥¨æ³•ã€‚è„šæœ¬ä¼šè¯„ä¼°è¯¸å¦‚ **"Hybrid Double Stability"** æˆ– **"Weighted Z-Std"** ç­‰ç­–ç•¥çš„å‡†ç¡®ç‡ã€‚

```bash
python analyze_data_insights.py --input_file data/math500_detailed.jsonl
```

  * **è¾“å‡º**: æ§åˆ¶å°å°†æ‰“å°å‡ºå„ç­–ç•¥çš„æ’è¡Œæ¦œï¼ˆLeaderboardï¼‰åŠå…¶ç›¸å¯¹äº Baseline çš„å¢ç›Šã€‚

### 4\. åŸºç¡€è¯„ä¼°ä¸éš¾é¢˜æŒ–æ˜

å¿«é€Ÿè¯„ä¼° SC å‡†ç¡®ç‡ï¼Œå¹¶ç­›é€‰å‡ºæ¨¡å‹æœ€â€œä¸ç¡®å®šâ€çš„é¢˜ç›®ï¼ˆHard Casesï¼‰ã€‚

```bash
python evaluate-sc.py \
    --input_file data/math500_candidates.jsonl \
    --output_hard_file data/hard_problems.jsonl \
    --top_k 50
```

### 5\. æ•°æ®åˆ†çº§ç­›é€‰

æ ¹æ®ä¸€è‡´æ€§åˆ†æ•°ï¼ˆSC Scoreï¼‰å°†æ•°æ®åˆ†ä¸º **Easy/Medium/Hard** ä¸‰ä¸ªç­‰çº§ï¼Œå¹¶æå–å‡ºç”Ÿæˆå…±è¯†ç­”æ¡ˆçš„é‚£æ¡æ¨ç†è·¯å¾„ã€‚è¿™å¯¹äºæ„å»º PPO/GRPO çš„è®­ç»ƒæ•°æ®éå¸¸æœ‰ç”¨ã€‚

```bash
python filter_difficulty.py \
    --input_file data/math500_candidates.jsonl \
    --output_dir data/training_buckets \
    --high_threshold 0.8 \
    --low_threshold 0.5
```

  * **ç­›é€‰é€»è¾‘**:
      * **Easy**: SC Score $\ge$ 0.8
      * **Hard**: SC Score $<$ 0.5
      * **é€‰æ‹©æœºåˆ¶**: å§‹ç»ˆé€‰æ‹©ç”Ÿæˆäº†â€œå…±è¯†ç­”æ¡ˆâ€çš„é‚£æ¡è·¯å¾„ï¼ˆå‡è®¾å®ƒæ˜¯æ­£ç¡®çš„ï¼‰ã€‚

-----

## ğŸ“Š æ ¸å¿ƒæŒ‡æ ‡è¯´æ˜

æœ¬å·¥å…·ç®±è®¡ç®—å¤šç§å†…åœ¨æŒ‡æ ‡ï¼ˆIntrinsic Metricsï¼‰ï¼Œç”¨äºåœ¨æ²¡æœ‰å¤–éƒ¨å¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼‰çš„æƒ…å†µä¸‹è¯„ä¼°æ¨ç†è´¨é‡ã€‚

| æŒ‡æ ‡ (Metric) | è¯´æ˜ |
| :--- | :--- |
| **SC Score** | **è‡ªæ´½æ€§åˆ†æ•°** (0.0 - 1.0)ã€‚æŒ‡ç”Ÿæˆå‡ºçš„ç­”æ¡ˆä¸­ï¼Œä¼—æ•°ç­”æ¡ˆå‡ºç°çš„é¢‘ç‡ã€‚é€šå¸¸ä½œä¸ºé¢˜ç›®éš¾åº¦çš„ä»£ç†æŒ‡æ ‡ã€‚ |
| **Avg Entropy** | **å¹³å‡ç†µ**ã€‚è¡¡é‡æ¨¡å‹åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­çš„å¹³å‡ä¸ç¡®å®šæ€§ã€‚æ•°å€¼è¶Šä½ï¼Œæ¨¡å‹è¶Šç¡®ä¿¡ã€‚ |
| **Certainty** | **ç¡®ä¿¡åº¦**ã€‚å½’ä¸€åŒ–çš„å¯¹æ•°æ¦‚ç‡æŒ‡æ ‡ï¼Œæ¶ˆé™¤äº†è¯è¡¨å¤§å°çš„å½±å“ã€‚æ•°å€¼è¶Šå¤§è¶Šå¥½ã€‚ |
| **Step-level Stability** | **æ­¥éª¤ç¨³å®šæ€§**ã€‚åˆ†æç‰¹å®šæ¨ç†æ­¥éª¤å†…çš„ç†µå€¼æ–¹å·®ï¼Œç”¨äºæ£€æµ‹æ¨¡å‹æ˜¯å¦åœ¨æŸä¸ªå…·ä½“æ­¥éª¤å‡ºç°â€œå¹»è§‰â€æˆ–çŠ¹è±«ã€‚ |
| **Z-Score Weighted** | **Z-Score åŠ æƒ**ã€‚åœ¨æ•°æ®é›†èŒƒå›´å†…å¯¹ç†µå€¼è¿›è¡Œæ ‡å‡†åŒ–ï¼Œç”¨äºæƒ©ç½šå¼‚å¸¸å€¼ã€‚ |
